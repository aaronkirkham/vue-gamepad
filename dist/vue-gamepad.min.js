/*!
 * vue-gamepad v2.0.0-beta.1
 * (c) 2020 Aaron Kirkham <aaron@kirkh.am>
 * Released under the MIT License.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).VueGamepad=t()}(this,function(){"use strict";var n=function(){return(n=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};var a=["left-analog-right","left-analog-down","right-analog-right","right-analog-down"],l=["left-analog-left","left-analog-up","right-analog-left","right-analog-up"],r={analogThreshold:.5,buttonNames:["button-a","button-b","button-x","button-y","shoulder-left","shoulder-right","trigger-left","trigger-right","button-select","button-start","left-stick-in","right-stick-in","button-dpad-up","button-dpad-down","button-dpad-left","button-dpad-right","vendor"],buttonInitialTimeout:200,buttonRepeatTimeout:200,injectClasses:!0,classPrefix:"v-gamepad"};function d(e,t,n){e[t[0]]=e[t[0]]||{};var r=e[t[0]];return 1<t.length?(t.shift(),d(r,t,n)):e[t[0]]=n,e}function u(e,t,n){void 0===n&&(n=void 0);var r=e[t[0]];return 1<t.length&&r?(t.shift(),u(r,t)||n):r||n}function o(s){return void 0===s&&(s=r),e.prototype.getGamepads=function(){return function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;for(var r=Array(e),o=0,t=0;t<n;t++)for(var i=arguments[t],a=0,s=i.length;a<s;a++,o++)r[o]=i[a];return r}(navigator.getGamepads()).filter(function(e){return null!==e})},e.prototype.validBinding=function(e,t){var n;if(void 0===e.arg)return 0;var r="function"==typeof e.value,o="function"==typeof(null===(n=null==t?void 0:t.props)||void 0===n?void 0:n.onClick);return r||o?2:1},e.prototype.findLayerForVnode=function(t){if(t)for(var e in this.vnodeLayers)if(this.vnodeLayers[e].find(function(e){return e===t}))return e;return""},e.prototype.addListener=function(e,t,n,r){var o=t.released?"released":"pressed",i=!!t.repeat,a=this.findLayerForVnode(r);0===u(this.events,[a,o,e],[]).length&&d(this.events,[a,o,e],[]),this.events[a][o][e].push({vnode:r,repeat:i,callback:n}),s.injectClasses&&r&&r.el&&r.el.classList.add(s.classPrefix,s.classPrefix+"--"+e)},e.prototype.removeListener=function(e,t,n,r){var o=t.released?"released":"pressed",i=this.findLayerForVnode(r),a=u(this.events,[i,o,e],[]);0!==a.length&&(0<(a=a.filter(function(e){return e.callback!==n})).length?d(this.events,[i,o,e],a):delete this.events[i][o][e])},e.prototype.createLayer=function(t,e){var n=this;Array.isArray(e.children)&&(void 0===this.vnodeLayers[t]&&(this.vnodeLayers[t]=[]),e.children.forEach(function(e){return n.vnodeLayers[t].push(e)}))},e.prototype.destroyLayer=function(e){e===this.currentLayer&&(this.currentLayer=this.prevLayers[e]),delete this.prevLayers[e],delete this.vnodeLayers[e],delete this.events[e]},e.prototype.switchToLayer=function(e){void 0===e&&(e=""),e!==this.currentLayer&&(""!==e&&(this.prevLayers[e]=this.currentLayer),this.currentLayer=e)},e.prototype.switchToDefaultLayer=function(){return this.switchToLayer("")},e.prototype.runPressedCallbacks=function(e){var t,n,r,o=u(this.events,[this.currentLayer,"pressed",e],[]);0<o.length&&(t=void 0===this.holding[e],n=Date.now(),r=o[o.length-1],(t||r.repeat&&n-this.holding[e]>=s.buttonRepeatTimeout)&&(this.holding[e]=n,t&&(this.holding[e]+=s.buttonInitialTimeout-s.buttonRepeatTimeout),r.callback.call(window)))},e.prototype.runReleasedCallbacks=function(e){delete this.holding[e];var t=u(this.events,[this.currentLayer,"released",e],[]);0<t.length&&t[t.length-1].callback.call(window)},e.prototype.update=function(){var i=this;this.getGamepads().forEach(function(e){e.buttons.forEach(function(e,t){var n=s.buttonNames[t];e.pressed?i.runPressedCallbacks(n):void 0!==i.holding[n]&&i.runReleasedCallbacks(n)}),e.axes.forEach(function(e,t){var n,r,o;e>=s.analogThreshold||e<=-s.analogThreshold?(o=t,n=0<e?a[o]:l[o],i.runPressedCallbacks(n)):[a[r=t],l[r]].filter(function(e){return i.holding[e]}).forEach(function(e){return i.runReleasedCallbacks(e)})})}),requestAnimationFrame(this.update.bind(this))},e;function e(){var e=this;this.events={},this.holding={},this.currentLayer="",this.prevLayers={},this.vnodeLayers={},window.addEventListener("gamepadconnected",function(){document.body.classList.add(s.classPrefix+"-connected")}),window.addEventListener("gamepaddisconnected",function(){0===e.getGamepads().length&&document.body.classList.remove(s.classPrefix+"-connected")}),requestAnimationFrame(this.update.bind(this))}}return{install:function(e,t){if(void 0===t&&(t={}),!("getGamepads"in navigator))return console.error("vue-gamepad: your browser does not support the Gamepad API!");var a=new(o(n(n({},r),t)));e.config.globalProperties.$gamepad=a,e.directive("gamepad",{beforeMount:function(e,t,n){var r,o=a.validBinding(t,n);if(2!==o)return console.error("vue-gamepad: '"+t.arg+"' was not bound. ("+function(e){switch(e){case 0:return"missing directive argument (v-gamepad:button)";case 1:return'missing directive callback (v-gamepad:button="callback")'}return""}(o)+")"),console.log(e);var i="function"==typeof t.value?t.value:null===(r=null==n?void 0:n.props)||void 0===r?void 0:r.onClick;a.addListener(t.arg,t.modifiers,i,n)},beforeUnmount:function(e,t,n){var r,o;2===a.validBinding(t,n)&&(o="function"==typeof t.value?t.value:null===(r=null==n?void 0:n.props)||void 0===r?void 0:r.onClick,a.removeListener(t.arg,t.modifiers,o,n))}}),e.directive("gamepad-layer",{beforeMount:function(e,t,n){if(void 0===t.value)return console.error("vue-gamepad: Failed to create layer. (invalid layer value)"),console.log(e);a.createLayer(t.value,n)},unmounted:function(e,t){void 0!==t.value&&a.destroyLayer(t.value)}})}}});
